<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joke Library - Spotify-Level Demo</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸš€</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-main: #121212;
            --bg-surface: #181818;
            --bg-surface-2: #282828;
            --bg-input: #2a2d3e;
            --border-color: #3e4042;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --accent-green: #1DB954;
            --accent-blue: #45a3ff;
            --accent-orange: #f5c518;
            --accent-purple: #9d6cff;
        }
        body { font-family: var(--font-sans); background-color: var(--bg-main); color: var(--text-primary); margin: 0; padding: 2rem; display: flex; justify-content: center; align-items: center; min-height: 100vh; box-sizing: border-box; }
        .demo-container { max-width: 500px; width: 100%; background: var(--bg-surface); padding: 1rem; border-radius: 12px; box-shadow: 0 10px B30px rgba(0,0,0,0.3); }
        h1 { text-align: center; margin-top: 0; color: var(--accent-green); }
        
        .joke-bank-panel { background: var(--bg-main); display: flex; flex-direction: column; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
        .panel-header { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); background: var(--bg-surface-2); display: flex; justify-content: space-between; align-items: center; }
        .panel-header h4 { margin: 0; font-size: 0.9rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; }
        .panel-actions { padding: 0.5rem 1rem; border-bottom: 1px solid var(--border-color); }
        .panel-actions input { width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 6px; padding: 0.75rem; color: var(--text-primary); font-size: 0.95rem; font-family: inherit; }
        
        .joke-bank-list { height: 450px; overflow-y: auto; padding: 0.5rem; }
        .joke-bank-item { background: var(--bg-surface-2); border: 1px solid transparent; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem; transition: all 0.2s ease; position: relative; }
        .joke-bank-item:hover { background: #3a3b3c; }
        .joke-item-text { font-size: 0.9rem; line-height: 1.3; color: var(--text-primary); margin-bottom: 0.5rem; padding-right: 2.5rem; }

        .joke-item-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: var(--text-secondary); }
        .metadata-pills { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .metadata-pill { background: var(--bg-main); color: var(--text-secondary); padding: 0.125rem 0.5rem; border-radius: 12px; font-weight: 500; font-size: 0.7rem; }
        .pill-story { background: var(--accent-blue); color: white; }
        .pill-clean { background: var(--accent-green); color: white; }
        .performance-score { display: flex; align-items: center; gap: 0.25rem; }
        .performance-score i { color: var(--accent-orange); }

        .filter-bar { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; padding: 0.5rem 1rem; border-bottom: 1px solid var(--border-color); }
        .filter-group { display: flex; flex-direction: column; gap: 0.25rem; }
        .filter-group label { font-size: 0.7rem; color: var(--text-secondary); }
        .filter-bar select { width: 100%; background-color: var(--bg-surface-2); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 0.8rem; padding: 0.25rem; }
        
        .joke-menu-btn { position: absolute; top: 0.5rem; right: 0.5rem; font-size: 1rem; color: var(--text-secondary); cursor: pointer; opacity: 0.5; transition: all 0.2s; background: none; border: none; }
        .joke-bank-item:hover .joke-menu-btn { opacity: 1; }
        .joke-menu { display: none; position: absolute; background: var(--bg-surface-2); border: 1px solid var(--border-color); border-radius: 4px; z-index: 10; padding: 0.5rem 0; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .joke-menu button { background: none; border: none; color: var(--text-primary); padding: 0.5rem 1rem; text-align: left; width: 100%; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 0.75rem; }
        .joke-menu button:hover { background: #3a3b3c; }
        .joke-menu i { width: 16px; text-align: center; }

        .view-toggle { display: flex; background: var(--bg-surface-2); border-radius: 8px; padding: 4px; margin: 0 1rem 1rem 1rem; }
        .view-toggle-btn { flex: 1; text-align: center; padding: 0.5rem; background: transparent; border: none; color: var(--text-secondary); font-weight: 600; border-radius: 6px; cursor: pointer; }
        .view-toggle-btn.active { background: #3a3b3c; color: var(--text-primary); }
        .discovery-page { display: none; padding: 0.5rem; height: 450px; overflow-y: auto; }
        .discovery-section { margin-bottom: 1.5rem; }
        .discovery-section h5 { margin: 0 0 0.75rem 0; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
        .discovery-item { background: var(--bg-surface-2); border-radius: 6px; padding: 0.75rem; display: flex; gap: 1rem; align-items: center; margin-bottom: 0.5rem; }
        .discovery-item i { color: var(--accent-purple); font-size: 1.5rem; }
        .discovery-item em { font-size: 0.8rem; color: var(--text-secondary); display: block; }

        .modal-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s; }
        .modal-container.visible { opacity: 1; visibility: visible; }
        .modal-content { background: var(--bg-surface-2); padding: 1.5rem; border-radius: 8px; max-width: 500px; width: 90%; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 0.75rem; margin-bottom: 1rem; }
        .modal-header h5 { margin: 0; font-size: 1rem; }
        .modal-close-btn { background: none; border: none; color: var(--text-secondary); font-size: 1.2rem; cursor: pointer; }
        .history-list { max-height: 300px; overflow-y: auto; }
        .history-item { display: flex; justify-content: space-between; padding: 0.75rem 0.25rem; border-bottom: 1px solid var(--border-color); }
        .history-item:last-child { border-bottom: none; }
        .history-item-venue { font-weight: 600; }
        .history-item-date { font-size: 0.8rem; color: var(--text-secondary); }

        .joke-card-second-line { display: flex; justify-content: space-between; align-items: center; }
        .last-performed-info { font-size: 0.75rem; color: var(--text-secondary); display: flex; align-items: center; gap: 0.5rem; }
        .last-performed-info i { color: var(--accent-blue); }
        .right-meta { display: flex; align-items: center; gap: 0.75rem; }

        .search-hint { font-size: 0.75rem; color: var(--text-secondary); padding: 0.25rem 1rem 0.5rem 1rem; }

        /* --- NEW FEATURE: Joke Versioning --- */
        .versions-icon { color: var(--text-secondary); font-size: 0.7rem; margin-left: 0.5rem; }
        .versions-list { max-height: 250px; overflow-y: auto; margin-bottom: 1rem; }
        .version-item { background: var(--bg-surface); border: 1px solid var(--border-color); border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem; }
        .version-item.is-primary { border-left: 3px solid var(--accent-green); }
        .version-text { margin-bottom: 0.5rem; }
        .version-actions { display: flex; justify-content: space-between; align-items: center; }
        .version-actions button { font-size: 0.8rem; background: none; border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer; }
        .version-actions button:hover { background: var(--bg-surface-2); }
        .version-actions button.delete-btn:hover { border-color: var(--accent-red); color: var(--accent-red); }
        .add-version-form { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
        .add-version-form textarea { width: 100%; background: var(--bg-input); border-radius: 4px; padding: 0.5rem; color: var(--text-primary); border: 1px solid var(--border-color); min-height: 50px; }
        .add-version-form button { margin-top: 0.5rem; background: var(--accent-green); border: none; color: white; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }

    </style>
</head>
<body>
    <div class="demo-container">
        <h1>JokeFlix</h1>

        <div class="view-toggle">
            <button class="view-toggle-btn active" data-view="library">Library</button>
            <button class="view-toggle-btn" data-view="discovery">Discovery</button>
        </div>

        <div id="libraryView">
            <div class="joke-bank-panel">
                <div class="panel-header"><h4><i class="fas fa-book-open"></i> Your Jokes</h4></div>
                <div class="panel-actions"><input type="search" id="jokeSearch" placeholder="Search your jokes..."></div>
                <div class="search-hint">Try: "clean story", "new", "opener", or even "clena"</div>
                
                <div class="filter-bar">
                    <div class="filter-group"><label for="sortBy">Sort by</label><select id="sortBy"><option value="createdAt_desc">Date Added</option><option value="performanceScore_desc">Best Performing</option><option value="useCount_desc">Most Used</option><option value="lastUsedAt_asc">Least Recently Used</option></select></div>
                    <div class="filter-group"><label for="filterType">Joke Type</label><select id="filterType"><option value="all">All Types</option><option value="One-liner">One-liner</option><option value="Story">Story</option><option value="Observational">Observational</option></select></div>
                </div>
                
                <div class="joke-bank-list" id="jokeBankList"></div>
            </div>
        </div>

        <div id="discoveryView" class="discovery-page" style="display: none;"></div>
    </div>

    <div id="historyModal" class="modal-container"></div>
    
    <!-- NEW FEATURE: Joke Versions Modal -->
    <div id="versionsModal" class="modal-container">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="versionsModalTitle">Manage Versions</h5>
                <button id="versionsModalClose" class="modal-close-btn">&times;</button>
            </div>
            <div id="versionsList" class="versions-list"></div>
            <div class="add-version-form">
                <textarea id="newVersionText" placeholder="Add a new punchline or setup..."></textarea>
                <button id="addVersionBtn">Add Version</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA STORE ---
        // NEW: Joke `text` is now a `versions` array. Each version has its own text and score.
        const dataStore = {
            jokes: [
                { id: 101, tags: ['travel', 'food', 'opener'], estimated_duration: 60, createdAt: '2025-08-19T10:00:00.000Z', isFavorite: true, lastUsedAt: '2025-08-19T21:30:00.000Z', useCount: 5, jokeType: 'Observational', venueSuitability: ['Bar', 'Late-night'],
                  versions: [
                      { id: 1, text: 'What\'s the deal with airplane food?', isPrimary: true, performanceScore: 4.5 },
                      { id: 2, text: 'Have you ever noticed how bad airplane food is?', isPrimary: false, performanceScore: 3.0 }
                  ]},
                { id: 102, tags: ['animals'], estimated_duration: 75, createdAt: '2025-08-15T11:00:00.000Z', isFavorite: false, lastUsedAt: '2024-08-19T22:00:00.000Z', useCount: 2, jokeType: 'One-liner', venueSuitability: ['Clean'],
                  versions: [ { id: 1, text: 'My cat is so lazy, the only exercise it gets is stretching... the truth.', isPrimary: true, performanceScore: 3.0 } ]},
                { id: 103, tags: ['animals', 'political'], estimated_duration: 50, createdAt: '2025-08-12T14:00:00.000Z', isFavorite: false, lastUsedAt: '2025-08-12T20:00:00.000Z', useCount: 10, jokeType: 'One-liner', venueSuitability: ['Clean'],
                  versions: [ { id: 1, text: 'Why don\'t dogs make good dancers? Because they have two left feet!', isPrimary: true, performanceScore: 4.0 } ]},
                { id: 104, tags: ['story', 'clean'], estimated_duration: 240, createdAt: '2025-07-20T09:00:00.000Z', isFavorite: true, lastUsedAt: '2025-07-20T13:00:00.000Z', useCount: 8, jokeType: 'Story', venueSuitability: ['Clean', 'Corporate'],
                  versions: [
                      { id: 1, text: 'So I was at the DMV the other day...', isPrimary: true, performanceScore: 5.0 },
                      { id: 2, text: 'The Department of Motor Vehicles is a strange place...', isPrimary: false, performanceScore: 4.0 },
                      { id: 3, text: 'You want to see humanity at its worst? Go to the DMV on a Monday.', isPrimary: false, performanceScore: 4.8 }
                  ]},
                { id: 105, tags: ['new', 'observational'], estimated_duration: 300, createdAt: '2025-08-18T18:00:00.000Z', isFavorite: false, lastUsedAt: null, useCount: 0, jokeType: 'Observational', venueSuitability: ['Bar'],
                  versions: [ { id: 1, text: 'New 5 minutes about coffee shops', isPrimary: true, performanceScore: null } ]},
            ],
            sets: [
                 { id: 1, date: '2025-08-19', title: 'Open Mic', venue: 'The Laugh Factory', setlist: [101] },
                 { id: 2, date: '2025-08-12', title: 'Showcase', venue: 'The Comedy Store', setlist: [103] },
            ],
            getAllJokes: function() { return this.jokes; },
            getJokeById: function(id) { return this.jokes.find(j => j.id === id); },
            getHistoryForJoke: function(jokeId) { return this.sets.filter(set => set.setlist.includes(jokeId)).sort((a, b) => new Date(b.date) - new Date(a.date)); }
        };

        const jokeBankEl = document.getElementById('jokeBankList');
        const sortByEl = document.getElementById('sortBy');
        const filterTypeEl = document.getElementById('filterType');
        const searchInput = document.getElementById('jokeSearch');
        const versionsModal = document.getElementById('versionsModal');
        let currentJokeForVersions = null;

        function levenshtein(a, b) { /* ... omitted for brevity ... */ return 0; }

        function renderJokeLibrary() {
            // ... (Search and sort logic omitted for brevity)
            let jokes = dataStore.getAllJokes(); // Simplified for demo
            
            jokeBankEl.innerHTML = jokes.map(joke => {
                const primaryVersion = joke.versions.find(v => v.isPrimary);
                const scoreHTML = primaryVersion.performanceScore ? `<div class="performance-score"><i class="fas fa-star"></i> ${primaryVersion.performanceScore.toFixed(1)}</div>` : '';
                const history = dataStore.getHistoryForJoke(joke.id);
                let lastPerformedHTML = '<div class="last-performed-info">&nbsp;</div>';
                if (history.length > 0) {
                    const lastSet = history[0];
                    lastPerformedHTML = `<div class="last-performed-info"><i class="fas fa-history"></i><span>${lastSet.venue} &middot; ${new Date(lastSet.date).toLocaleDateString()}</span></div>`;
                }
                const pillsHTML = `<div class="metadata-pills"><span class="metadata-pill pill-${joke.jokeType.toLowerCase()}">${joke.jokeType}</span>${joke.venueSuitability.includes('Clean') ? '<span class="metadata-pill pill-clean">Clean</span>' : ''}</div>`;
                
                // NEW: Add versions icon if there's more than one version
                const versionsIconHTML = joke.versions.length > 1 ? `<i class="fas fa-layer-group versions-icon" title="${joke.versions.length} versions"></i>` : '';

                return `
                    <div class="joke-bank-item" data-joke-id="${joke.id}">
                        <button class="joke-menu-btn" data-action="openMenu"><i class="fas fa-ellipsis-h"></i></button>
                        <div class="joke-item-text">${primaryVersion.text} ${versionsIconHTML}</div>
                        <div class="joke-card-second-line">${lastPerformedHTML}<div class="right-meta">${pillsHTML}${scoreHTML}</div></div>
                    </div>`;
            }).join('');
        }
        
        // --- EVENT LISTENERS ---
        sortByEl.addEventListener('change', renderJokeLibrary);
        filterTypeEl.addEventListener('change', renderJokeLibrary);
        searchInput.addEventListener('input', renderJokeLibrary);

        jokeBankEl.addEventListener('click', e => {
            if (e.target.closest('[data-action="openMenu"]')) {
                const jokeId = e.target.closest('.joke-bank-item').dataset.jokeId;
                showJokeMenu(e.target, jokeId);
            }
        });

        function showJokeMenu(button, jokeId) {
            closeAllMenus();
            const menu = document.createElement('div');
            menu.className = 'joke-menu';
            menu.style.position = 'absolute';
            menu.innerHTML = `
                <button data-action="jokeRadio"><i class="fas fa-broadcast-tower"></i> Start Joke Radio</button>
                <button data-action="manageVersions"><i class="fas fa-layer-group"></i> Manage Versions</button>
                <button data-action="viewHistory"><i class="fas fa-history"></i> View Full History</button>
            `;
            document.body.appendChild(menu);
            const btnRect = button.getBoundingClientRect();
            menu.style.display = 'block';
            menu.style.top = `${btnRect.bottom}px`;
            menu.style.left = `${btnRect.right - menu.offsetWidth}px`;

            // NEW: Listener for the versions button
            menu.querySelector('[data-action="manageVersions"]').addEventListener('click', () => {
                showVersionsModal(parseInt(jokeId));
                closeAllMenus();
            });
            menu.querySelector('[data-action="viewHistory"]').addEventListener('click', () => { /* ... */ });
        }

        function closeAllMenus() { document.querySelectorAll('.joke-menu').forEach(menu => menu.remove()); }
        document.addEventListener('click', e => { if (!e.target.closest('.joke-menu') && !e.target.closest('[data-action="openMenu"]')) { closeAllMenus(); } });

        // --- NEW FEATURE: Joke Versioning Logic ---
        function showVersionsModal(jokeId) {
            currentJokeForVersions = dataStore.getJokeById(jokeId);
            const primaryVersion = currentJokeForVersions.versions.find(v => v.isPrimary);
            document.getElementById('versionsModalTitle').textContent = `Versions for "${primaryVersion.text.substring(0, 20)}..."`;
            renderVersionsList();
            versionsModal.classList.add('visible');
        }

        function renderVersionsList() {
            const listEl = document.getElementById('versionsList');
            listEl.innerHTML = currentJokeForVersions.versions.map(v => `
                <div class="version-item ${v.isPrimary ? 'is-primary' : ''}">
                    <div class="version-text">${v.text}</div>
                    <div class="version-actions">
                        <span>Score: ${v.performanceScore || 'N/A'}</span>
                        <div>
                            <button data-action="makePrimary" data-version-id="${v.id}" ${v.isPrimary ? 'disabled' : ''}>Make Primary</button>
                            <button class="delete-btn" data-action="deleteVersion" data-version-id="${v.id}" ${v.isPrimary ? 'disabled' : ''}>Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('versionsModalClose').addEventListener('click', () => versionsModal.classList.remove('visible'));
        document.getElementById('addVersionBtn').addEventListener('click', () => {
            const text = document.getElementById('newVersionText').value;
            if (text && currentJokeForVersions) {
                currentJokeForVersions.versions.push({
                    id: Date.now(),
                    text: text,
                    isPrimary: false,
                    performanceScore: null
                });
                document.getElementById('newVersionText').value = '';
                renderVersionsList();
            }
        });

        document.getElementById('versionsList').addEventListener('click', e => {
            const action = e.target.dataset.action;
            const versionId = parseInt(e.target.dataset.versionId);
            if (!action || !versionId || !currentJokeForVersions) return;

            if (action === 'makePrimary') {
                currentJokeForVersions.versions.forEach(v => v.isPrimary = (v.id === versionId));
                renderVersionsList();
                renderJokeLibrary();
            }
            if (action === 'deleteVersion') {
                if (confirm('Are you sure you want to delete this version?')) {
                    currentJokeForVersions.versions = currentJokeForVersions.versions.filter(v => v.id !== versionId);
                    renderVersionsList();
                }
            }
        });

        // Initial Render
        renderJokeLibrary();
    });
    </script>
</body>
</html>
